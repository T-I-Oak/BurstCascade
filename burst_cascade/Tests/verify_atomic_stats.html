<!DOCTYPE html>
<html>

<head>
    <title>Atomic Stats Verification</title>
</head>

<body>
    <div id="output"></div>
    <script>
        window.BurstCascade = {};
    </script>
    <script src="../map.js"></script>
    <script src="../achievements.js"></script>
    <script>
        function log(msg, color = 'black') {
            const div = document.getElementById('output');
            div.innerHTML += `<div style="color:${color}">${msg}</div>`;
        }
        function assert(condition, msg) {
            if (condition) {
                log(`[PASS] ${msg}`, 'green');
            } else {
                log(`[FAIL] ${msg}`, 'red');
            }
        }

        try {
            const { AchievementManager, StatItem } = window.BurstCascade;

            log("Starting Atomic Stats Verification...");

            if (!StatItem) {
                throw new Error("StatItem class not found in window.BurstCascade");
            }

            // 1. Test StatItem
            const stat = new StatItem();
            stat.add(10);
            assert(stat.action === 10, "StatItem.add updates action");
            assert(stat.turn === 10, "StatItem.add updates turn");
            assert(stat.game === 10, "StatItem.add updates game");
            assert(stat.maxAction === 10, "StatItem.add updates maxAction");

            stat.newAction();
            assert(stat.action === 0, "StatItem.newAction resets action");
            assert(stat.turn === 10, "StatItem.newAction preserves turn");
            assert(stat.maxAction === 10, "StatItem.newAction preserves maxAction within turn");

            stat.add(15);
            assert(stat.action === 15, "Added 15 in new action");
            assert(stat.maxAction === 15, "maxAction updated to 15 (new max)");
            assert(stat.turn === 25, "Turn total is 10+15=25");

            stat.newTurn();
            assert(stat.turn === 0, "newTurn resets turn");
            assert(stat.maxAction === 0, "newTurn resets maxAction");
            assert(stat.game === 25, "Game total persists (25)");
            assert(stat.maxTurn === 25, "maxTurn updated to 25 before reset? Wait, code says 'if (this.turn > this.maxTurn) this.maxTurn = this.turn' in add().");
            // Check maxTurn logic
            // When add(15) happened, turn became 25. maxTurn should have become 25.
            // newTurn() resets turn to 0. maxTurn persists? 
            // StatItem code: newTurn() { this.turn = 0; this.maxAction = 0; }
            // It does NOT reset maxTurn. Correct.
            // And newGame() resets maxTurn.

            // Let's verify maxTurn persistence
            const stat2 = new StatItem();
            stat2.add(10);
            assert(stat2.maxTurn === 10, "maxTurn is 10");
            stat2.newTurn();
            assert(stat2.maxTurn === 10, "maxTurn persists after newTurn");
            stat2.add(5);
            assert(stat2.maxTurn === 10, "maxTurn 10 > current 5");
            stat2.add(20); // turn = 25
            assert(stat2.maxTurn === 25, "maxTurn updated to 25");

            // 2. Test AchievementManager Integration
            const am = new AchievementManager();
            assert(am.stats.actions instanceof StatItem, "stats.actions initialized");
            assert(am.stats.bursts instanceof StatItem, "stats.bursts initialized");

            am.startNewGame();
            am.stats.actions.add(1);
            assert(am.stats.actions.game === 1, "AM stats functional");

            am.startNewAction();
            assert(am.stats.actions.action === 0, "AM startNewAction works");

            am.startNewTurn();
            assert(am.stats.actions.turn === 0, "AM startNewTurn works");

            log("Verification Complete.", 'blue');

        } catch (e) {
            log(`CRITICAL ERROR: ${e.message}`, 'red');
            console.error(e);
        }
    </script>
</body>

</html>